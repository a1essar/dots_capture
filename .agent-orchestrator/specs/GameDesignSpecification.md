# Game Design Specification

**Название:** Contours
**Тип:** Пошаговая стратегическая игра на сетке
**Режимы:** PvP (локально), PvC (бот)
**Платформа:** Web (mobile-friendly, desktop first)
**Стек:**

* **UI:** React
* **Рендер поля:** PixiJS (WebGL + Canvas fallback)
* **Core (логика):** TypeScript (чистая логика без привязки к UI)
* **Сборка:** Vite
* **Тесты:** Playwright (e2e)

---

# 0. Термины и определения

Чтобы избежать двусмысленностей, ниже используются следующие термины:

* **Пересечение** (node, intersection) — узел сетки с координатой `(x, y)`, куда можно поставить точку.
* **Край поля** — любое пересечение, для которого `x = 0` или `x = W-1` или `y = 0` или `y = H-1`.
* **Активная точка** — точка игрока с `captured: false`. Только активные точки образуют «стены» для захвата.
* **Захваченная точка** — точка с `captured: true`. Она остаётся на поле, но **не** является стеной.
* **Территория** (`territory`) — пересечения, которые стали недоступны для постановки после захвата.

Важно: в этой спецификации **нет “клеток” между линиями** — вся логика игры (ходы и захват) работает на **пересечениях**.

---

# 1. Структура экранов

## 1.1 Стартовый экран

**Элементы:**

* Кнопка: `Player vs Player`
* Кнопка: `Player vs Computer`
* Кнопка: `Settings`

---

## 1.2 Экран выбора параметров матча

### Общие настройки:

* Размер поля (предустановки: 10×10, 10×20, 20×20)
* Выбор цвета игрока 1
* Выбор цвета игрока 2 (или бота)

### Для PvC:

* Выбор сложности бота:

  * Easy
  * Medium
  * Hard

Кнопка: `Start Game`

---

## 1.3 Игровой экран

**Области:**

* Игровое поле (центр)
* Панель статуса:

  * Счёт: `P1 : P2`
  * Индикатор текущего хода
* Кнопки:

  * Surrender (досрочная сдача)
  * Restart
  * Back to Menu

---

## 1.4 Экран результата

Отображается после окончания партии:

* Итоговый счёт
* Победитель (или ничья)
* Кнопки: `Rematch`, `Back to Menu`

---

## 1.5 Настройки

* Вкл/выкл анимации
* Подсветка потенциального захвата (on/off)
* Размер точек
* Толщина линий

---

# 2. Геометрия поля

## 2.1 Сетка

* Точки ставятся **строго на пересечениях** линий сетки (как в Go).
* Области между линиями остаются пустыми.
* Связность графа — **8-направленная** (ортогональные + диагональные соседи).

Каждое пересечение имеет до 8 соседей:

```
(x-1,y-1) (x,y-1) (x+1,y-1)
(x-1,y  )    *    (x+1,y  )
(x-1,y+1) (x,y+1) (x+1,y+1)
```

---

## 2.2 Координаты

Каждое пересечение имеет координату `(x, y)`, где:

```
0 ≤ x < W
0 ≤ y < H
```

W и H определяются предустановкой поля.

---

# 3. Правила хода

## 3.1 Размещение точки

* Игроки ходят по очереди. Первый ход — Игрок 1.
* За один ход игрок ставит **одну точку** на любое **свободное** пересечение.
* Нельзя ставить точку на:

  * Пересечение, занятое любой точкой (своей или чужой, включая захваченные).
  * Пересечение, заблокированное территорией противника.

## 3.2 После размещения

После каждого хода выполняется проверка захвата (раздел 4).

---

# 4. Механика захвата

## 4.1 Принцип

Захват определяется **единственным механизмом** — flood-fill анализом на **пересечениях**:

Если область пересечений (пустые + точки противника + захваченные точки + территория) **полностью окружена** активными точками текущего игрока и не имеет выхода к **краю поля** — эта область считается захваченной.

## 4.2 Алгоритм (flood-fill)

После каждого хода:

1. Рассматриваются **только активные точки противника** (`captured: false`) как потенциально захватываемые.
2. Для каждой ещё не обработанной активной точки противника запускается flood-fill по пересечениям.
3. Flood-fill распространяется по **4-связным** (ортогональным) направлениям.
4. Flood-fill **не проходит** через активные точки текущего игрока (они являются «стенами»).
5. Flood-fill **проходит** через:

   * пустые пересечения
   * активные точки противника
   * захваченные точки (любой стороны)
   * территорию

6. Если flood-fill **достигает края поля** — у области есть выход, захвата нет.
7. Если flood-fill **не достигает края поля** — область замкнута и считается захваченной.

Результат для замкнутой области:

* Все **активные точки противника** внутри помечаются `captured` → +1 очко за каждую (только за точки, которые стали `captured` в этот ход).
* Все **пустые пересечения** внутри блокируются (становятся территорией текущего игрока).

Примечание: `territory` влияет **только** на запрет постановки (раздел 3.1) и визуализацию (раздел 4.4). В механике захвата «стенами» являются **только активные точки** текущего игрока.

### Почему 4-связный flood-fill при 8-связном контуре

Это стандартное правило дискретной топологии: **8-связная граница** блокирует **4-связное** распространение. Диагональная линия из точек игрока образует непроходимую стену для ортогонального flood-fill.

## 4.3 Ключевые правила захвата

* На практике, для формирования замкнутого контура обычно требуется **не менее 4 точек**, но в реализации это **не проверяется отдельно** — захват определяется только flood-fill по правилам выше.
* **Захват необратим** — захваченная точка остаётся помеченной навсегда.
* Захваченные точки **остаются на поле** визуально (отображаются затемнёнными / перечёркнутыми).
* Захваченные точки **не являются стенками** — они не участвуют в формировании контуров.
* Только **активные** (незахваченные) точки игрока образуют стенки для flood-fill.
* Контур засчитывается, только если внутри есть **хотя бы одна точка противника**.

### Множественные захваты одним ходом

Один ход может замкнуть несколько несвязанных областей. В этом случае:

* Все такие области обрабатываются в рамках одной проверки после хода.
* Очки суммируются по количеству **новых** захваченных точек противника.

## 4.4 Визуализация захвата

* Захваченная территория заливается **полупрозрачным цветом** захватившего игрока.
* Захваченные точки противника внутри территории отображаются затемнёнными.

---

# 5. Модель данных

```ts
type PlayerId = 1 | 2

type CellState =
  | { type: "empty" }
  | { type: "point"; owner: PlayerId; captured: boolean }
  | { type: "territory"; owner: PlayerId }

interface GameSettings {
  width: number
  height: number
  mode: "PVP" | "PVC"
  botDifficulty?: "easy" | "medium" | "hard"
  playerColors: Record<PlayerId, string>
}

interface GameState {
  settings: GameSettings
  board: Map<string, CellState>  // ключ: "x,y"; отсутствие ключа эквивалентно { type: "empty" }
  score: Record<PlayerId, number>
  currentPlayer: PlayerId
  status: "playing" | "finished"
  winner: PlayerId | "draw" | null
  moveHistory: Array<{ x: number; y: number; player: PlayerId }>
}
```

---

# 6. Алгоритмы бота

Бот работает только в режиме PvC (всегда Игрок 2).

---

## 6.1 Easy

**Стратегия:** случайный ход с приоритетом немедленного захвата.

Алгоритм:

1. Найти все свободные пересечения.
2. Для каждого — симулировать ход и проверить, даёт ли он захват.
3. Если есть ход с захватом → выбрать его.
4. Иначе → случайный свободный ход.

Сложность: O(N), где N — количество свободных пересечений.

---

## 6.2 Medium

**Стратегия:** оценочная функция для каждого возможного хода.

```
score =
  + 10 * immediate_captures
  + 3  * pressure_count
  - 5  * opponent_capture_risk
```

Определения:

* `immediate_captures` — количество точек противника, захваченных этим ходом (результат flood-fill).
* `pressure_count` — количество точек противника, у которых после этого хода остаётся только 1 свободный ортогональный сосед (не заблокированный точками текущего игрока).
* `opponent_capture_risk` — 1, если после этого хода противник может на следующем ходу захватить точку текущего игрока; 0 иначе.

Алгоритм:

1. Перебор всех свободных позиций.
2. Симуляция хода, расчёт score.
3. Выбор хода с максимальным score.

Сложность: O(N²)

---

## 6.3 Hard

**Стратегия:** минимакс с alpha-beta pruning и ограниченной глубиной (2–3).

Оценочная функция:

```
heuristic =
  (my_score - opponent_score) * 20
  + potential_captures * 5
  + controlled_territory * 2
  - opponent_threats * 8
```

Определения:

* `my_score`, `opponent_score` — текущий счёт (количество захваченных точек).
* `potential_captures` — количество точек противника, у которых ≤ 2 свободных ортогональных соседа.
* `controlled_territory` — количество пустых пересечений, окружённых преимущественно своими точками (≥ 5 из 8 соседей).
* `opponent_threats` — количество своих точек, у которых ≤ 2 свободных ортогональных соседа.

Оптимизации:

* Alpha-beta pruning.
* Перебор только **релевантных ходов** — пересечения в радиусе 2 шагов от существующих точек (например, дистанция Чебышёва ≤ 2), а не все свободные.
* Ограничение времени хода: ≤ 200 мс.

---

# 7. Условия завершения игры

Игра заканчивается при выполнении **любого** из условий:

### 7.1 Нет свободных ходов

Все пересечения заняты или заблокированы территорией.

### 7.2 Досрочное завершение (автоматическое)

Опционально (по умолчанию **выключено**).

Ранее предлагалось правило на основе `remaining_free`, но оно не является гарантированно корректным, потому что один ход может привести к захвату **нескольких** точек и счёт может измениться скачком.

Если требуется “ускоряющее” завершение для казуального режима, оно должно быть либо:

* чисто UX-эвристикой (с явным предупреждением игроку), либо
* доказуемо безопасным ограничением (требует отдельной формализации верхней оценки максимального прироста очков).

### 7.3 Сдача

Игрок нажимает `Surrender`. Противник объявляется победителем.

### Определение победителя

Побеждает игрок с большим счётом. При равном счёте — ничья.
